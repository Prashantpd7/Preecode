<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Auth callback</title>
  <script src="/theme.js"></script>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    body {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      font-family: Inter, system-ui, Arial;
    }
    .cb-container { text-align: center; max-width: 520px; padding: 24px; }
    .cb-title { margin-bottom: 8px; color: var(--text-primary); }
    .cb-msg { color: var(--text-muted); }
    .cb-actions { margin-top: 18px; display: none; }
    .cb-link-primary { color: var(--accent); margin-right: 12px; text-decoration: none; }
    .cb-link-primary:hover { color: var(--accent-hover); }
    .cb-link-secondary { color: var(--text-muted); text-decoration: none; }
    .cb-link-secondary:hover { color: var(--text-primary); }
    .cb-btn {
      display: inline-block;
      margin-top: 18px;
      padding: 10px 14px;
      background: var(--accent);
      color: var(--text-inverse);
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      transition: background 0.2s ease;
    }
    .cb-btn:hover { background: var(--accent-hover); }
  </style>
</head>
<body>
  <div class="cb-container" id="container">
    <h2 class="cb-title" id="title">Signing you in&hellip;</h2>
    <p class="cb-msg" id="msg">Please wait &mdash; finishing authentication.</p>
    <div class="cb-actions" id="actions">
      <a id="goLogin" href="/login.html" class="cb-link-primary">Go to Sign In</a>
      <a id="goHome" href="/" class="cb-link-secondary">Return Home</a>
    </div>
  </div>

  <script>
    (async function () {
      try {
        var params = new URLSearchParams(window.location.search);
        var token = params.get('token');
        var error = params.get('error');
        var msg = document.getElementById('msg');

        if (error && !token) {
          var title = document.getElementById('title');
          title.textContent = 'Authentication failed';
          msg.textContent = 'There was a problem signing you in: ' + (error || 'unknown error') + '. Please try again.';
          console.warn('OAuth error:', error);
          var actions = document.getElementById('actions');
          actions.style.display = 'block';
          return;
        }

        if (token) {
          try { localStorage.setItem('token', token); } catch (e) { /* ignore */ }

          try {
            var meRes = await fetch('https://preecode.onrender.com/api/users/me', {
              headers: { Authorization: 'Bearer ' + token },
              credentials: 'include'
            });
            if (meRes.ok) {
              var me = await meRes.json();
              if (me && me._id) localStorage.setItem('preecode_uid', me._id);

              var resolvedName = '';
              if (me && me.username) {
                resolvedName = me.username;
              } else if (me && me.email && me.email.indexOf('@') !== -1) {
                resolvedName = me.email.split('@')[0];
              }
              if (resolvedName) localStorage.setItem('preecode_name', resolvedName);

              if (me && me.plan) localStorage.setItem('preecode_plan', me.plan);
              if (me && me.foundingBadgeLevel) localStorage.setItem('preecode_badge', me.foundingBadgeLevel);
              if (me && me.hasShared !== undefined) localStorage.setItem('preecode_shared', me.hasShared);
            }
          } catch (e) {
            // Ignore hydrate failure; token is still valid
          }

          if (window.opener && !window.opener.closed) {
            try {
              window.opener.postMessage({ type: 'preecode_oauth', token: token }, '*');
            } catch (e) {}
            window.close();
            return;
          }

          var redirectParam = params.get('redirect');
          if (redirectParam) {
            try {
              var decoded = decodeURIComponent(redirectParam);
            } catch (e) {
              var decoded = redirectParam;
            }

            var sep = decoded.indexOf('?') === -1 ? '?' : '&';
            var deepLink = decoded + sep + 'token=' + encodeURIComponent(token);

            try {
              window.location.href = deepLink;
              return;
            } catch (e) {}

            var container = document.getElementById('container');
            msg.textContent = 'Signed in \u2014 click the button below to open VS Code.';
            var btn = document.createElement('a');
            btn.href = deepLink;
            btn.textContent = 'Open in VS Code';
            btn.className = 'cb-btn';
            container.appendChild(btn);
            return;
          }

          msg.textContent = 'Signed in \u2014 redirecting to dashboard...';
          params.delete('token');
          var newSearch = params.toString();
          var newUrl = '/pages/dashboard.html' + (newSearch ? '?' + newSearch : '');
          setTimeout(function () { window.location.href = newUrl; }, 700);
          return;
        }

        title.textContent = 'Authentication incomplete';
        msg.textContent = 'No authentication token was returned. Please sign in manually.';
        document.getElementById('actions').style.display = 'block';
      } catch (e) {
        try { localStorage.removeItem('token'); } catch (e) {}
        window.location.href = '/login.html';
      }
    })();
  </script>
</body>
</html>
